<!DOCTYPE html>
<html>
<head>
    <title>Anarchy Chess</title>
    <meta name="description" content="A massive multiplayer chess board with slightly bent rules. Here be anarchy.">
    <meta name="keywords" content="chess anarchy game multiplayer online">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
</head>

<body onmousedown="dragging = true" onmousemove="onDragBody(event)"
      onwheel="onWheelBody(event)" onmouseup="dragging = false">
    
    <p class="copyright-notice">
        If you're seeing this, you probably moved the board offscreen. ¬©Anarchy Chess, Zekiah-A
    </p>

    <div id="board">
        <!-- Parent element that contains all canvases -->
    </div>

    <div class="hud game-title">
        <p>Anarchy Chess</p>
    </div>

    <div class="hud game-actions">
        <p onclick="
            if (chatPanel.getAttribute('closed'))
                chatPanel.removeAttribute('closed')
            else
                chatPanel.setAttribute('closed', true)
        ">Chat</p>
        <p>Settings</p>
        <p>Help</p>
    </div>

    <div id="chatPanel" closed="true" class="info-panel">
        <div id="chatMessages">
            <span>>> Chat messages will appear here</span>
            <span deathevent>üíÄ Pawn killed at (1, 1) A1</span>
            <span spawnevent>‚ú® Pawn spawned at (1, 1) A1</span>
        </div>
        <input type="text" maxlength="250" onkeydown="
            if (event.key == 'Enter') {
                sendChatMessage(this.value)
                this.value = ''
            }
        " />
    </div>

    <div id="turnPanel" class="info-panel">
        <div id="turnProgress"></div>
        <div id="turnLabel" style="white-space: pre;">Current turn: 1             (5s)</div>
    </div>
    
    <div id="infoPanel" class="info-panel">
        <p>Zoom: <span id="zoomIndicator">0.4</span>x</p>
        <p>Board: <span id="boardIndicator">0, 0</span></p>
        <p>Position: <span id="tileIndicator">A1</span></p>
    </div>

    <div id="deathMenu" closed="true" class="menu">
        <h1 style="margin-bottom: 8px;">‚ôüÔ∏è BLUNDER</h1>
        <p>You were killed by another piece.</p>
        <div class="dual-options">
            <input value="Respawn on map" type="button">
            <input value="Main menu" type="button">
        </div>
    </div>
    
    <div id="mainMenu" class="menu main-menu">
        <h1>Anarchy Chess</h1>
        <p>A massive multiplayer chess board, with multiple gamemodes and slightly bent rules. Here be anarchy.</p>
        <p>Choose a piece</p>
        <div class="scroll-picker" id="sc"
            onwheel="scroll({ left: event.deltaY + this.scrollLeft, top: 0, behavior: 'smooth' })"
            onclick="
                this.current = this.querySelector('[selected]')
                if (current != null) current.removeAttribute('selected')
                event.target.setAttribute('selected', true)
                pieceType = pieceTypes[event.target.textContent]
            ">
            <div selected>Pawn<img src="Assets/pawn.svg"></div>
            <div>Bishop<img src="Assets/bishop.svg"></div>
            <div>Knight<img src="Assets/knight.svg"></div>
            <div>Rook<img src="Assets/rook.svg"></div>
            <div>Queen<img src="Assets/queen.svg"></div>
            <div>King<img src="Assets/king.svg"></div>
        </div>
        <div style="flex-grow: 1;"></div>
        <div>Choose a colour</div>
        <div style="flex-grow: 1;"></div>
        <div class="dual-options" onclick="
                this.current = this.querySelector('[selected]')
                if (current != null) current.removeAttribute('selected')
                event.target.setAttribute('selected', true)
                pieceColour = pieceColours[event.target.textContent]
            ">
            <div class="black-white" style="color: white; background-color: black;">Black</div>
            <div selected class="black-white" style="color: black; background-color: white;">White</div>
        </div>
        <div style="flex-grow: 1;"></div>
        <input value="Play" type="button" onclick="
            mainMenu.style.display = 'none';
            spawnMenu.style.display = 'flex';
            selectSpawnLocation()
        ">
        <div style="flex-grow: 1;"></div>
    </div>

    <div id="spawnMenu" style="display: none;" class="menu spawn-menu">
        <h2>Choose your spawn location</h2>
        <div class="dual-options">
            <input value="Spawn by friend" type="button" style="pointer-events: none;">
            <input value="Random location" type="button">
        </div>
    </div>

    <div id="warningMenu">
        <img id="warningMenuBackground" src="https://upload.wikimedia.org/wikipedia/commons/6/66/Chess_gameboard..jpg">
        <h1>Anarchy Chess</h1>
        <h2>‚ö†Ô∏è This game is an early alpha, expect bugs</h2>
        <p>A massive multiplayer chess board, with multiple gamemodes and slightly bent rules. Here be anarchy.</p>
        <input value="Proceed" type="button" style="width: 300px; align-self: center;" onclick="
            warningMenu.animate([
                { transform: 'scale(1)' },
                { opacity: '1' },
                { transform: 'scale(1.1)' },
                { opacity: '0' },
            ], {
                duration: 1000,
                iterations: 1
            })
            warningMenuBackground.animate([
                { transform: 'scale(1)' },
                { transform: 'scale(0.9)' },
            ], {
                duration: 1000,
                iterations: 1
            })

            window.setTimeout(() => { warningMenu.remove() }, 600)
        ">
    </div>
</body>
<script>
    // Board width = tile width * columns
    let TILE_HEIGHT = 64
    let TILE_WIDTH = 64
    let ROWS = 8
    let COLUMNS = 8
    let CANVASES = []

    const serverPackets = {
        // Info sent only to the player
        Canvases: 0,
        Token: 1,

        // Relayed information from other clients
        Move: 2,
        Spawn: 3,
        Chat: 4,
        PieceKilled: 5,
        TurnChanged: 6,

        // Actions and responses
        RejectMove: 7,
        RejectSpawn: 8,
        RejectChat: 9,
        RejectToken: 10,
        FriendRequest: 11,
        FriendAdded: 12,
        FriendRemoved: 13,
        FriendsOnline: 14
    }

    const clientPackets = {
        Spawn: 0,
        Move: 1,
        Chat: 2,
        RequestFriend: 3,
        AcceptFriend: 4
    }

    const pieceTypes = {
        Bishop: 0,
        King: 1,
        Knight: 2,
        Pawn: 3,
        Queen: 4,
        Rook: 5
    }

    const pieceColours = {
        White: 0,
        Black: 1
    }

    const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    const encoder = new TextEncoder()
    const decoder = new TextDecoder()
    const piecesBlack = [
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: none; fill-rule: evenodd; fill-opacity: 1; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <g style="fill: #000000; stroke: #000000; stroke-linecap: butt"> 
                <path d="M 9,36 C 12.39,35.03 19.11,36.43 22.5,34 C 25.89,36.43 32.61,35.03 36,36 C 36,36 37.65,36.54 39,38 C 38.32,38.97 37.35,38.99 36,38.5 C 32.61,37.53 25.89,38.96 22.5,37.5 C 19.11,38.96 12.39,37.53 9,38.5 C 7.646,38.99 6.677,38.97 6,38 C 7.354,36.06 9,36 9,36 z"/>
                <path d="M 15,32 C 17.5,34.5 27.5,34.5 30,32 C 30.5,30.5 30,30 30,30 C 30,27.5 27.5,26 27.5,26 C 33,24.5 33.5,14.5 22.5,10.5 C 11.5,14.5 12,24.5 17.5,26 C 17.5,26 15,27.5 15,30 C 15,30 14.5,30.5 15,32 z"/>
                <path d="M 25 8 A 2.5 2.5 0 1 1  20,8 A 2.5 2.5 0 1 1  25 8 z"/>
                </g>
                <path d="M 17.5,26 L 27.5,26 M 15,30 L 30,30 M 25 16 A 2.5 2.5 0 1 1  20,16 A 2.5 2.5 0 1 1  25 16 z" style="fill: none; stroke: #ffffff; stroke-linejoin: miter"/>
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="fill: none; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <path d="M 22.5,25 C 22.5,25 27,17.5 25.5,14.5 C 25.5,14.5 24.5,12 22.5,12 C 20.5,12 19.5,14.5 19.5,14.5 C 18,17.5 22.5,25 22.5,25" style="fill: #000000, fill-opacity: 1, stroke-linecap: butt, stroke-linejoin: miter" />
                <path d="M 11.5,37 C 17,40.5 27,40.5 32.5,37 L 32.5,30 C 32.5,30 41.5,25.5 38.5,19.5 C 34.5,13 25,16 22.5,23.5 L 22.5,27 L 22.5,23.5 C 19,16 9.5,13 6.5,19.5 C 3.5,25.5 11.5,29.5 11.5,29.5 L 11.5,37 z " style="fill: #000000; stroke: #000000"/>
                <path d="M 32,29.5 C 32,29.5 40.5,25.5 38.03,19.85 C 34.15,14 25,18 22.5,24.5 L 22.51,26.6 L 22.5,24.5 C 20,18 9.906,14 6.997,19.85 C 4.5,25.5 11.85,28.85 11.85,28.85" style="fill: none; stroke: #ffffff" />
                <path d="M 11.5,30 C 17,27 27,27 32.5,30 M 11.5,33.5 C 17,30.5 27,30.5 32.5,33.5 M 11.5,37 C 17,34 27,34 32.5,37" style="fill: none; stroke: #ffffff" />
                <path d="M 25 8 A 2.5 2.5 0 1 1  20,8 A 2.5 2.5 0 1 1  25 8 z" style="fill: #ffffff; stroke: #000000" />
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: none; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <path
                    d="M 22,10 C 32.5,11 38.5,18 38,39 L 15,39 C 15,30 25,32.5 23,18"
                    style="fill: #000000; stroke: #000000" />
                <path
                    d="M 24,18 C 24.38,20.91 18.45,25.37 16,27 C 13,29 13.18,31.34 11,31 C 9.958,30.06 12.41,27.96 11,28 C 10,28 11.19,29.23 10,30 C 9,30 5.997,31 6,26 C 6,24 12,14 12,14 C 12,14 13.89,12.1 14,10.5 C 13.27,9.506 13.5,8.5 13.5,7.5 C 14.5,6.5 16.5,10 16.5,10 L 18.5,10 C 18.5,10 19.28,8.008 21,7 C 22,7 22,10 22,10"
                    style="fill: #000000; stroke: #000000" />
                <path
                    d="M 9.5 25.5 A 0.5 0.5 0 1 1 8.5,25.5 A 0.5 0.5 0 1 1 9.5 25.5 z"
                    style="fill: #ffffff; stroke: #ffffff" />
                <path
                    d="M 15 15.5 A 0.5 1.5 0 1 1  14,15.5 A 0.5 1.5 0 1 1  15 15.5 z"
                    transform="matrix(0.866,0.5,-0.5,0.866,9.693,-5.173)"
                    style="fill: #ffffff; stroke: #ffffff" />
                <path
                    d="M 24.55,10.4 L 24.1,11.85 L 24.6,12 C 27.75,13 30.25,14.49 32.5,18.75 C 34.75,23.01 35.75,29.06 35.25,39 L 35.2,39.5 L 37.45,39.5 L 37.5,39 C 38,28.94 36.62,22.15 34.25,17.66 C 31.88,13.17 28.46,11.02 25.06,10.5 L 24.55,10.4 z "
                    style="fill: #ffffff; stroke: none" />
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g>
                <path d="M 22,9 C 19.79,9 18,10.79 18,13 C 18,13.89 18.29,14.71 18.78,15.38 C 16.83,16.5 15.5,18.59 15.5,21 C 15.5,23.03 16.44,24.84 17.91,26.03 C 14.91,27.09 10.5,31.58 10.5,39.5 L 33.5,39.5 C 33.5,31.58 29.09,27.09 26.09,26.03 C 27.56,24.84 28.5,23.03 28.5,21 C 28.5,18.59 27.17,16.5 25.22,15.38 C 25.71,14.71 26,13.89 26,13 C 26,10.79 24.21,9 22,9 z " style="opacity: 1; fill: #000000; fill-opacity: 1; fill-rule: nonzero; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: miter; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1"/>
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: #000000; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <g style="fill: #000000; stroke: none">
                <circle cx="6"    cy="12" r="2.75" />
                <circle cx="14"   cy="9"  r="2.75" />
                <circle cx="22.5" cy="8"  r="2.75" />
                <circle cx="31"   cy="9"  r="2.75" />
                <circle cx="39"   cy="12" r="2.75" />
                </g>
                <path d="M 9,26 C 17.5,24.5 30,24.5 36,26 L 38.5,13.5 L 31,25 L 30.7,10.9 L 25.5,24.5 L 22.5,10 L 19.5,24.5 L 14.3,10.9 L 14,25 L 6.5,13.5 L 9,26 z"
                    style="stroke-linecap: butt; stroke: #000000" />
                <path
                    d="M 9,26 C 9,28 10.5,28 11.5,30 C 12.5,31.5 12.5,31 12,33.5 C 10.5,34.5 10.5,36 10.5,36 C 9,37.5 11,38.5 11,38.5 C 17.5,39.5 27.5,39.5 34,38.5 C 34,38.5 35.5,37.5 34,36 C 34,36 34.5,34.5 33,33.5 C 32.5,31 32.5,31.5 33.5,30 C 34.5,28 36,28 36,26 C 27.5,24.5 17.5,24.5 9,26 z"
                    style="stroke-linecap: butt" />
                <path
                    d="M 11,38.5 A 35,35 1 0 0 34,38.5"
                    style="fill: none; stroke: #000000; stroke-linecap: butt" />
                <path
                    d="M 11,29 A 35,35 1 0 1 34,29"
                    style="fill: none; stroke: #ffffff" />
                <path
                    d="M 12.5,31.5 L 32.5,31.5"
                    style="fill: none; stroke: #ffffff" />
                <path
                    d="M 11.5,34.5 A 35,35 1 0 0 33.5,34.5"
                    style="fill: none; stroke: #ffffff" />
                <path
                    d="M 10.5,37.5 A 35,35 1 0 0 34.5,37.5"
                    style="fill: none; stroke: #ffffff" />
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: #000000; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <path
                    d="M 9,39 L 36,39 L 36,36 L 9,36 L 9,39 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 12.5,32 L 14,29.5 L 31,29.5 L 32.5,32 L 12.5,32 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 12,36 L 12,32 L 33,32 L 33,36 L 12,36 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 14,29.5 L 14,16.5 L 31,16.5 L 31,29.5 L 14,29.5 z "
                    style="stroke-linecap: butt; stroke-linejoin: miter" />
                <path
                    d="M 14,16.5 L 11,14 L 34,14 L 31,16.5 L 14,16.5 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 11,14 L 11,9 L 15,9 L 15,11 L 20,11 L 20,9 L 25,9 L 25,11 L 30,11 L 30,9 L 34,9 L 34,14 L 11,14 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 12,35.5 L 33,35.5 L 33,35.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 13,31.5 L 32,31.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 14,29.5 L 31,29.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 14,16.5 L 31,16.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 11,14 L 34,14"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
            </g>
        </svg>
        `
    ]
    const piecesWhite = [
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: none; fill-rule: evenodd; fill-opacity: 1; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <g style="fill: #e3e3e3; stroke: #e3e3e3; stroke-linecap: butt;"> 
                <path d="M 9,36 C 12.39,35.03 19.11,36.43 22.5,34 C 25.89,36.43 32.61,35.03 36,36 C 36,36 37.65,36.54 39,38 C 38.32,38.97 37.35,38.99 36,38.5 C 32.61,37.53 25.89,38.96 22.5,37.5 C 19.11,38.96 12.39,37.53 9,38.5 C 7.646,38.99 6.677,38.97 6,38 C 7.354,36.06 9,36 9,36 z"/>
                <path d="M 15,32 C 17.5,34.5 27.5,34.5 30,32 C 30.5,30.5 30,30 30,30 C 30,27.5 27.5,26 27.5,26 C 33,24.5 33.5,14.5 22.5,10.5 C 11.5,14.5 12,24.5 17.5,26 C 17.5,26 15,27.5 15,30 C 15,30 14.5,30.5 15,32 z"/>
                <path d="M 25 8 A 2.5 2.5 0 1 1  20,8 A 2.5 2.5 0 1 1  25 8 z"/>
                </g>
                <path d="M 17.5,26 L 27.5,26 M 15,30 L 30,30 M 25 16 A 2.5 2.5 0 1 1  20,16 A 2.5 2.5 0 1 1  25 16 z" style="fill: none; stroke: #ffffff; stroke-linejoin: miter"/>
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="fill: none; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <path d="M 22.5,25 C 22.5,25 27,17.5 25.5,14.5 C 25.5,14.5 24.5,12 22.5,12 C 20.5,12 19.5,14.5 19.5,14.5 C 18,17.5 22.5,25 22.5,25" style="fill: #000000, fill-opacity: 1, stroke-linecap: butt, stroke-linejoin: miter" />
                <path d="M 11.5,37 C 17,40.5 27,40.5 32.5,37 L 32.5,30 C 32.5,30 41.5,25.5 38.5,19.5 C 34.5,13 25,16 22.5,23.5 L 22.5,27 L 22.5,23.5 C 19,16 9.5,13 6.5,19.5 C 3.5,25.5 11.5,29.5 11.5,29.5 L 11.5,37 z " style="fill: #000000; stroke: #000000"/>
                <path d="M 32,29.5 C 32,29.5 40.5,25.5 38.03,19.85 C 34.15,14 25,18 22.5,24.5 L 22.51,26.6 L 22.5,24.5 C 20,18 9.906,14 6.997,19.85 C 4.5,25.5 11.85,28.85 11.85,28.85" style="fill: none; stroke: #ffffff" />
                <path d="M 11.5,30 C 17,27 27,27 32.5,30 M 11.5,33.5 C 17,30.5 27,30.5 32.5,33.5 M 11.5,37 C 17,34 27,34 32.5,37" style="fill: none; stroke: #ffffff" />
                <path d="M 25 8 A 2.5 2.5 0 1 1  20,8 A 2.5 2.5 0 1 1  25 8 z" style="fill: #ffffff; stroke: #000000" />
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: none; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <path
                    d="M 22,10 C 32.5,11 38.5,18 38,39 L 15,39 C 15,30 25,32.5 23,18"
                    style="fill: #000000; stroke: #000000" />
                <path
                    d="M 24,18 C 24.38,20.91 18.45,25.37 16,27 C 13,29 13.18,31.34 11,31 C 9.958,30.06 12.41,27.96 11,28 C 10,28 11.19,29.23 10,30 C 9,30 5.997,31 6,26 C 6,24 12,14 12,14 C 12,14 13.89,12.1 14,10.5 C 13.27,9.506 13.5,8.5 13.5,7.5 C 14.5,6.5 16.5,10 16.5,10 L 18.5,10 C 18.5,10 19.28,8.008 21,7 C 22,7 22,10 22,10"
                    style="fill: #000000; stroke: #000000" />
                <path
                    d="M 9.5 25.5 A 0.5 0.5 0 1 1 8.5,25.5 A 0.5 0.5 0 1 1 9.5 25.5 z"
                    style="fill: #ffffff; stroke: #ffffff" />
                <path
                    d="M 15 15.5 A 0.5 1.5 0 1 1  14,15.5 A 0.5 1.5 0 1 1  15 15.5 z"
                    transform="matrix(0.866,0.5,-0.5,0.866,9.693,-5.173)"
                    style="fill: #ffffff; stroke: #ffffff" />
                <path
                    d="M 24.55,10.4 L 24.1,11.85 L 24.6,12 C 27.75,13 30.25,14.49 32.5,18.75 C 34.75,23.01 35.75,29.06 35.25,39 L 35.2,39.5 L 37.45,39.5 L 37.5,39 C 38,28.94 36.62,22.15 34.25,17.66 C 31.88,13.17 28.46,11.02 25.06,10.5 L 24.55,10.4 z "
                    style="fill: #ffffff; stroke: none" />
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g>
                <path d="M 22,9 C 19.79,9 18,10.79 18,13 C 18,13.89 18.29,14.71 18.78,15.38 C 16.83,16.5 15.5,18.59 15.5,21 C 15.5,23.03 16.44,24.84 17.91,26.03 C 14.91,27.09 10.5,31.58 10.5,39.5 L 33.5,39.5 C 33.5,31.58 29.09,27.09 26.09,26.03 C 27.56,24.84 28.5,23.03 28.5,21 C 28.5,18.59 27.17,16.5 25.22,15.38 C 25.71,14.71 26,13.89 26,13 C 26,10.79 24.21,9 22,9 z " style="opacity: 1; fill: #000000; fill-opacity: 1; fill-rule: nonzero; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: miter; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1"/>
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: #000000; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <g style="fill: #000000; stroke: none">
                <circle cx="6"    cy="12" r="2.75" />
                <circle cx="14"   cy="9"  r="2.75" />
                <circle cx="22.5" cy="8"  r="2.75" />
                <circle cx="31"   cy="9"  r="2.75" />
                <circle cx="39"   cy="12" r="2.75" />
                </g>
                <path d="M 9,26 C 17.5,24.5 30,24.5 36,26 L 38.5,13.5 L 31,25 L 30.7,10.9 L 25.5,24.5 L 22.5,10 L 19.5,24.5 L 14.3,10.9 L 14,25 L 6.5,13.5 L 9,26 z"
                    style="stroke-linecap: butt; stroke: #000000" />
                <path
                    d="M 9,26 C 9,28 10.5,28 11.5,30 C 12.5,31.5 12.5,31 12,33.5 C 10.5,34.5 10.5,36 10.5,36 C 9,37.5 11,38.5 11,38.5 C 17.5,39.5 27.5,39.5 34,38.5 C 34,38.5 35.5,37.5 34,36 C 34,36 34.5,34.5 33,33.5 C 32.5,31 32.5,31.5 33.5,30 C 34.5,28 36,28 36,26 C 27.5,24.5 17.5,24.5 9,26 z"
                    style="stroke-linecap: butt" />
                <path
                    d="M 11,38.5 A 35,35 1 0 0 34,38.5"
                    style="fill: none; stroke: #000000; stroke-linecap: butt" />
                <path
                    d="M 11,29 A 35,35 1 0 1 34,29"
                    style="fill: none; stroke: #ffffff" />
                <path
                    d="M 12.5,31.5 L 32.5,31.5"
                    style="fill: none; stroke: #ffffff" />
                <path
                    d="M 11.5,34.5 A 35,35 1 0 0 33.5,34.5"
                    style="fill: none; stroke: #ffffff" />
                <path
                    d="M 10.5,37.5 A 35,35 1 0 0 34.5,37.5"
                    style="fill: none; stroke: #ffffff" />
            </g>
        </svg>
        `,
        `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
            <g style="opacity: 1; fill: #000000; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1">
                <path
                    d="M 9,39 L 36,39 L 36,36 L 9,36 L 9,39 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 12.5,32 L 14,29.5 L 31,29.5 L 32.5,32 L 12.5,32 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 12,36 L 12,32 L 33,32 L 33,36 L 12,36 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 14,29.5 L 14,16.5 L 31,16.5 L 31,29.5 L 14,29.5 z "
                    style="stroke-linecap: butt; stroke-linejoin: miter" />
                <path
                    d="M 14,16.5 L 11,14 L 34,14 L 31,16.5 L 14,16.5 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 11,14 L 11,9 L 15,9 L 15,11 L 20,11 L 20,9 L 25,9 L 25,11 L 30,11 L 30,9 L 34,9 L 34,14 L 11,14 z "
                    style="stroke-linecap: butt" />
                <path
                    d="M 12,35.5 L 33,35.5 L 33,35.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 13,31.5 L 32,31.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 14,29.5 L 31,29.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 14,16.5 L 31,16.5"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
                <path
                    d="M 11,14 L 34,14"
                    style="fill: none; stroke: #ffffff; stroke-width: 1; stroke-linejoin: miter" />
            </g>
        </svg>
        `
    ]
</script>
<script>

    let ws = null
    let map = null
    let dragging = false
    let inputPermitted = true
    let zoom = 0.4
    let pieceType = pieceTypes.Pawn
    let pieceColour = pieceColours.White
    let positionEase = null

    function Map(boardsRows, boardsColumns, pieceRows, pieceColumns) { 
        this.boards = []
        this.boardsRows = boardsRows
        this.boardsColumns = boardsColumns

        // Fill board array
        for (let x = 0; x < boardsColumns; x++) {
            this.boards[x] = []

            for (let y = 0; y < boardsRows; y++) {
                this.boards[x][y] = new Board(pieceRows, pieceColumns)
            }
        }
    }

    function Board(pieceRows, pieceColumns) {
        this.pieces = []
        this.pieceRows = pieceRows
        this.pieceColumns = pieceColumns

        for (let x = 0; x < pieceColumns; x++) {
            this.pieces[x] = []
        }
    }

    function Piece(type, colour) {
        this.type = type
        this.colour = colour
    }

    function connect(address) {
        ws = new WebSocket(address)

        ws.onmessage = async ({data}) => {
            data = new DataView(await data.arrayBuffer())

            switch (data.getUint8(0)) {
                case serverPackets.Canvases: {
                    let boardsRows = data.getUint8(1), boardsColumns = data.getUint8(2),
                        pieceRows = data.getUint8(3), pieceColumns = data.getUint8(4)

                    board.style.width = (COLUMNS * TILE_WIDTH * boardsColumns) + "px"
                    board.style.height = (ROWS * TILE_HEIGHT * boardsRows) + "px"
                    
                    map = new Map(boardsRows, boardsColumns, pieceRows, pieceColumns)

                    let pieceArray = data.buffer.slice(5)
                    for (let i = 0; i < pieceArray.length; i += 6) {
                        let mapRow, mapColumn, boardRow, boardColumn, type, colour 
                        [mapRow, mapColumn, boardRow, boardColumn, type, colour] = pieceArray.slice(i, i + 6)
                        
                        // Add piece to board at right place, piece type is at index 4, colour is at index 5 
                        map.boards[mapRow][mapColumn].pieces[boardRow][boardColumn] = new Piece(type, colour)
                    }

                    createAllCanvases()
                    break
                }
                case serverPackets.Token: {
                    let token = decoder.decode(data.buffer.slice(1))
                    localStorage.token = token
                    break
                }
                case serverPackets.Move: {

                    break
                }
                case serverPackets.Spawn: {
                    
                    break
                }

                case serverPackets.Chat: {
                    let el = document.createElement("span")
                    el.textContent = ">> " + decoder.decode(data.buffer.slice(1))
                    chatMessages.appendChild(el)
                    chatMessages.appendChild(document.createElement("br"))

                    // Limit chat messages from becoming too long and causing issues
                    chatMessages.scrollTo(0, chatMessages.scrollHeight)
                    if (chatMessages.childElementCount > 100)
                        chatMessages.removeChild(chatMessages.firstElementChild)
                    break
                }
                case serverPackets.FriendRequest:
                    break
                case serverPackets.FriendAdded:
                    break
                case serverPackets.FriendRemoved:
                    break
                case serverPackets.FriendsOnline:
                    break
            }
        }
        
        ws.onclose = (event) => {

        }
    }

    function sendChatMessage(message) {
        let encoded = encoder.encode("0" + message)
        encoded[0] = clientPackets.Chat
        ws.send(encoded)
    }

    function createAllCanvases() {
        for (let mapX = 0; mapX < map.boardsColumns; mapX++) {
            for (let mapY = 0; mapY < map.boardsRows; mapY++) {
                let el = document.createElement("canvas")
                el.width = TILE_WIDTH * COLUMNS
                el.height = TILE_HEIGHT * ROWS
                el.style.left = (el.width * mapX) + "px"
                el.style.top = (el.width * mapY) + "px"
                el.setAttribute("column", mapX)
                el.setAttribute("row", mapY)

                board.appendChild(el)
            }
        }

        board.querySelectorAll("canvas").forEach(canvas => {
            drawCheckeredBackground(canvas)
            canvas.addEventListener("mousedown", onCanvasMouseDown)
        })
    }

    function fillTile(canvas, tileColumn, tileRow, special = false) {
        // Reroute to neighbouring canvas if the location is outside bounds, for seamless canvas interop.
        // After, adjust the tileColumn/tileRow to where it would be relative to canvas in neighbour.
        while (tileColumn < 0) {
            canvas = board.querySelector(
                `[column="${Number(canvas.getAttribute("column")) - 1}"][row="${canvas.getAttribute("row")}"]`)
            if (canvas == null) return

                tileColumn = COLUMNS - Math.abs(tileColumn)
        }
        while (tileRow < 0) {
            canvas = board.querySelector(
                `[column="${canvas.getAttribute("column")}"][row="${Number(canvas.getAttribute("row")) - 1}"]`)
            if (canvas == null) return

            tileRow = ROWS - Math.abs(tileRow)
        }
        while (tileColumn > COLUMNS - 1) {
            canvas = board.querySelector(
                `[column="${Number(canvas.getAttribute("column")) + 1}"][row="${canvas.getAttribute("row")}"]`)
            if (canvas == null) return

            tileColumn -= COLUMNS
        }
        while (tileRow > ROWS - 1) {
            canvas = board.querySelector(
                `[column="${canvas.getAttribute("column")}"][row="${Number(canvas.getAttribute("row")) + 1}"]`)
            if (canvas == null) return

            tileRow -= ROWS
        }

        // We skip if our shifting resulted in a canvas not even on the board
        const ctx = canvas.getContext("2d", { alpha: false })

        ctx.fillStyle = special ? "#8bff6185" : "#61a6ff85"
        ctx.fillRect(tileColumn * TILE_WIDTH, tileRow * TILE_HEIGHT, TILE_WIDTH, TILE_HEIGHT)
    }

    function drawValidMoves(canvas, pieceColumn, pieceRow, pieceType) {
        const ctx = canvas.getContext("2d", { alpha: false })
        const column = Number(event.target.getAttribute("column"))
        const row = Number(event.target.getAttribute("row")) 
        const pieces = map.boards[column][row].pieces

        // TODO: Show moves that would put you in danger (or in king's case, check)
        switch(pieceType) {
            case pieceTypes.Bishop:
                /*for (let x = pieceColumn - COLUMNS; x < pieceColumn + COLUMNS + 1; x++) {
                    if (x == pieceColumn) continue
                    fillTile(canvas, x, x + pieceRow, (pieces[x] != null && pieces[x][x] != null))
                    //fillTile(canvas, x, -x - pieceRow, (pieces[x] != null && pieces[x][-x] != null))
                }*/
                break
            case pieceTypes.King:
                // TODO: Include invalidated moves from others putting in check
                // We create a square/border of allowed around, excluding central current pos
                for (let x = pieceColumn - 1; x <= pieceColumn + 1; x++) {
                    for (let y = pieceRow - 1; y <= pieceRow + 1; y++) {
                        if (x == pieceColumn && y == pieceRow) continue
                        if (pieces[x] != null && pieces[x][y] != null) {
                            fillTile(canvas, x, y, true)
                            break
                        }

                        fillTile(canvas, x, y, )
                    }
                }
                break
            case pieceTypes.Knight:
                const rookMoves = [
                    [ pieceColumn + 1, pieceRow + 2 ],
                    [ pieceColumn + 2, pieceRow + 1 ],
                    [ pieceColumn + 2, pieceRow - 1 ],
                    [ pieceColumn + 1, pieceRow - 2 ],
                    [ pieceColumn - 1, pieceRow - 2 ],
                    [ pieceColumn - 2, pieceRow - 1 ],
                    [ pieceColumn - 2, pieceRow + 1 ],
                    [ pieceColumn - 1, pieceRow + 2 ]
                ]

                for (let move of rookMoves) {
                    fillTile(canvas, move[0], move[1], (pieces[move[0]] != null  && pieces[move[0]][move[1]] != null))
                }
                break
            case pieceTypes.Pawn:
                // TODO: Implement correct suggestions for pawn colour variations
                // Possible diagonal pawn take moves, if there's something there then fill specilal, else regular
                if (pieces[pieceColumn - 1] != null  && pieces[pieceColumn - 1][pieceRow - 1] != null)
                    fillTile(canvas, pieceColumn - 1, pieceRow - 1, true)
                else if (pieces[pieceColumn - 1] != null && pieces[pieceColumn - 1][pieceRow + 1] != null)
                    fillTile(canvas, pieceColumn - 1, pieceRow + 1, true)
                else
                    fillTile(canvas, pieceColumn, pieceRow - 1)
                break
            case pieceTypes.Queen:
                //TODO: Depends on bishop
            case pieceTypes.Rook:
                for (let x = -COLUMNS + pieceColumn; x < COLUMNS + pieceColumn + 1; x++) {
                    if (x == pieceColumn) continue
                    if (pieces[x] != null  && pieces[x][pieceRow] != null) {
                        fillTile(canvas, x, pieceRow, true)
                        break
                    }

                    fillTile(canvas, x, pieceRow)
                }

                for (let y = -ROWS + pieceRow; y < ROWS + pieceRow + 1; y++) {
                    if (y == pieceRow) continue
                    if (pieces[pieceColumn] != null  && pieces[pieceColumn][y] != null) {
                        fillTile(canvas, pieceColumn, y, true)
                        break
                    }

                    fillTile(canvas, pieceColumn, y)
                }
                break
        }
    }

    function selectSpawnLocation() {
        inputPermitted = false
        setZoom(0.4)
        setPosition(map.boardsColumns / 2, map.boardsRows / 2, 0, 0)

        function canvasMouseMove(event) {
            let tileOverX = Math.floor(event.offsetX / TILE_WIDTH)
            let tileOverY = Math.floor(event.offsetY / TILE_HEIGHT)

            drawCheckeredBackground(event.target)
            fillTile(event.target, tileOverX, tileOverY)
        }

        function canvasMouseLeave(event) {
            drawCheckeredBackground(event.target)
        }

        function canvasMouseUp(event) {
            let tileOverX = Math.floor(event.offsetX / TILE_WIDTH)
            let tileOverY = Math.floor(event.offsetY / TILE_HEIGHT)

            board.querySelectorAll("canvas").forEach(canvas => {
                canvas.removeEventListener("mousemove", canvasMouseMove)
                canvas.removeEventListener("mouseleave", canvasMouseLeave)
                canvas.removeEventListener("mouseup", canvasMouseUp)
            })

            drawCheckeredBackground(event.target)

            setZoom(1)
            setPosition(+event.target.getAttribute("column"), +event.target.getAttribute("row"), tileOverX, tileOverY)
            window.setTimeout(() => {
                inputPermitted = true
            }, 100)


            spawnMenu.animate([
                { opactiy: '0' },
                { top: '-10%' },
            ], {
                duration: 200,
                iterations: 1
            })

            window.setTimeout(() => spawnMenu.style.display = "none", 200)

            let spawnArray = new Uint8Array(7)
            spawnArray[0] = clientPackets.Spawn
            spawnArray[1] = +event.target.getAttribute("column")
            spawnArray[2] = +event.target.getAttribute("row")
            spawnArray[3] = tileOverX
            spawnArray[4] = tileOverY
            spawnArray[5] = pieceType
            spawnArray[6] = pieceColour

            ws.send(spawnArray)
        }

        board.querySelectorAll("canvas").forEach(canvas => {           
            canvas.addEventListener("mousemove", canvasMouseMove)
            canvas.addEventListener("mouseleave", canvasMouseLeave)
            canvas.addEventListener("mouseup", canvasMouseUp)
        })
    }

    function drawPieces(mapColumn, mapRow, tileColumn, tileRow) {
        const canvas = board.querySelector(`[column="${mapColumn}"][row="${mapRow}"]`)
        const ctx = canvas.getContext("2d", { alpha: false })
        const virtualBoard = map.boards[mapColumn][mapRow]

        ctx.fillStyle = type == 1 ? "white" : "black"
        // Iterate through each path in SVG, draw, convert SVG to a new format
    }

    function drawCheckeredBackground(canvas) {
        const ctx = canvas.getContext("2d", { alpha: false })

        ctx.fillStyle = "white"
        ctx.fillRect(0, 0, canvas.width, canvas.height)
        
        let shift = false
        for (let row = 0; row < ROWS; row++) {
            for (let column = 0; column < COLUMNS; column++) {
                if (column % 2 != 0) continue

                let x = (column + shift) * TILE_WIDTH
                let y = row * TILE_HEIGHT
                let gradientBlack = ctx.createLinearGradient(x, y, x + TILE_WIDTH, y + TILE_HEIGHT)

                gradientBlack.addColorStop(0, "#3C3C3C")
                gradientBlack.addColorStop(1, "black")
                ctx.fillStyle = gradientBlack
                ctx.fillRect(x, y, TILE_WIDTH, TILE_HEIGHT)
            }

            shift = !shift
        }
    }

    function easeOutCubic(progress) {
        return 1 - Math.pow(1 - progress, 3)
    }

    // We place the column, row in the screen centre
    function setPosition(boardColumn, boardRow, tileColumn, tileRow) {
        let centreX = window.innerWidth / 2, centreY = window.innerHeight / 2
        let finalLeft = (centreX - ((boardColumn * TILE_WIDTH * COLUMNS) + (tileColumn * TILE_WIDTH)) * zoom)
        let finalTop = (centreY - ((boardRow * TILE_HEIGHT * ROWS) + (tileRow * TILE_HEIGHT)) * zoom)
        let initialLeft = board.offsetLeft
        let initialTop = board.offsetTop
        let current = 0
        const repeats = 50

        positionEase = setInterval(() => {
            let ease = easeOutCubic(current / repeats)

            board.style.left = (ease * (finalLeft - initialLeft) + initialLeft) + "px"
            board.style.top = (ease * (finalTop - initialTop) + initialTop) + "px"

            current++
            if (current >= repeats) clearInterval(positionEase)
        }, 16)
    }

    function setZoom(zoomLevel) {
        let centreX = window.innerWidth / 2, centreY = window.innerHeight / 2, oldZoom = zoom
        zoom = Math.min(Math.max(zoomLevel, 0.4), 2)

        zoomIndicator.textContent = Math.round(zoom * 100) / 100
        board.style.transform = `scale(${zoom})`
    }

    function onDragBody(event) {
        if (!dragging || !inputPermitted) return
        if (event.target != document.body && !board.contains(event.target)) return
        clearInterval(positionEase)

        board.style.left = board.offsetLeft + event.movementX + "px"
        board.style.top = board.offsetTop + event.movementY + "px"
    }

    function onWheelBody(event) {
        if (event.target != document.body && !board.contains(event.target) || !inputPermitted) return
        setZoom(event.deltaY < 0 ? zoom + 0.2 : zoom - 0.2)
    }

    function onCanvasMouseDown(event) {
        let tileClickedX = Math.floor(event.offsetX / TILE_WIDTH)
        let tileClickedY = Math.floor(event.offsetY / TILE_HEIGHT)

        drawValidMoves(event.target, tileClickedX, tileClickedY, pieceTypes.Bishop)

        tileIndicator.textContent = 
            (tileClickedX < 26 ? ALPHABET[tileClickedX] : tileClickedX + ", ") + tileClickedY.toString() 
        boardIndicator.textContent = 
            `${Number(event.target.getAttribute("column")) + 1}, ${Number(event.target.getAttribute("row")) + 1}`
    }

    connect(localStorage.address || "wss://server.poemanthology.org:8083")
</script>
</html>
